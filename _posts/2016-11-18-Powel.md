---
layout: post
title:  "Detecting Water Leakages with Powel"
author: "Pedro Dias"
author-link: "#"
#author-image: "{{ site.baseurl }}/images/authors/photo.jpg"
date:   2016-05-19
categories: IoT
color: "blue"
#image: "{{ site.baseurl }}/images/imagename.png" #should be ~350px tall
excerpt: This article is aimed a providing a template to create IoT Ascend+ win articles.
language: English
verticals: Water, Smart Cities, Environmental
---

# Detecting water leakages with Powel
 
## Customer Profile

Powel spans Europe with a broad and sustainable customer base and a long history as trusted supplier of software solutions for cities / municipalities, counties, the energy industry, as well as the contracting sector. Ca USD 50M revenue and 400 employees. The company has offices across Norway as well as in Sweden, Denmark, Switzerland, Chile, Turkey and Poland. 
 
## Pain point

Water leakages in public water distribution systems are a waste of resources and should be detected and repaired as early as possible.

For Norway as an average one estimates that as much as 32% of the water supply gets wasted due to leakages. One major challenge with the water distribution system is the age of the various components in the infrastructure.

This report will summarize learnings from a one week engagement with Powel, where we explored using data from existing SCADA (Supervisory control and data acquisition) systems with Azure Machine Learning models, to create an application to detect leakages as early as possible.

 
## Solution 

The solution will monitor current water flow into a water distibution system and in real-time detect anomalies in the flow compared to a machine learning based prediction of expected water flow. The users of the system will be alerted and provided with insights to take the approperiate actions to stop the leakage as early as possible.

When more sensors and smart water meters are installed, the solution will have a potential to provide a lot more intelligence. 

A key part of the solution is the use of machine learning.

### Data available for analysis 

For this project, we had the following data available:
-	Sensor data for water flow into a few of the water distribution zones in Trondheim municipality. The sensor data had a variety in frequency and time span. The goal was to have a complete data set for the three previous years (2013 – 2015), but due to issues with sensor availability there were some gaps in the data. 
-	Reports written by the municipality on various incidents / repairs done related to the water distribution system.

### Hypothesis 

If we could accurately predict the “normal” water flow into a given zone for the next few hours, we could quickly detect anomalies in the current water flow that would likely be caused by water leakages.

### Process 

To be successful with data analysis and working with Machine Learning models we need to understand the whole process from the raw data until we have a reasonably good model, that is ready to be used by the application. The process we used is illustrated below. It’s important to understand that the process is not strictly sequential and that one may need to go back and iterate several times before a good model is achieved.

![Process](./images/process.png)

### Pre-processing of data files 

We got several data files that were exported from the SCADA system in Excel format for each sensor measuring water flow. Each file contained some Excel tabs with data for different date ranges. Some of the sensor values was representing water flow into a zone and others water flow out of the zone. The files contained sensor data with various frequencies and some files contained sensor data, which was only reported if the values changed from previous value.

To simplify the processing of the data later in the process, we created a C# program to pre-process the data by doing the following:
-	Combine different Excel files / tabs for various sensors for a water distribution zone into one consolidated CSV file
-	Calculate the total water flow into a zone by correctly considering the sensors measuring water flowing in / out of a zone
-	Create a uniform frequency for the sensor data by aggregating / distributing values on fixed intervals.
-	Splitting Datetime column into Year, Weekday (Monday, Tuesday, ..., Sunday), Quarter, Month, Hour, FiveMinute (each 24-hour split into 5-minute intervals), Holiday (flag for public holidays).

### Visualizing the data 

To better understand the data, visualization is a great tool. We used Power BI Desktop during the process to explore the data using various kind of visualizations. Exploring the data in Power BI allowed us to quickly look for patterns and get a lot better insight into the data. This helps us to identify what data we need to include in the dataset and maybe also what additional cleaning that needs to be done before we start to experiment with data in machine learning.

![Visualize Data](./images/PowerBIVisualize1.jpg)

### Azure ML Studio Experiments 

From the visualization done with Power BI we learned that the water flow into the water distribution system follows a daily pattern with some exceptions of weekends and possibly public holidays. To allow for a somewhat granular model for water flow within a 24-hour period, we decided to split every 24-hour into 5-minute intervals. We also included a flag to indicate whether a given sample time is associated with a public holiday or not.

We created the following Azure ML Experiment to test various features and machine learning algorithms:

![Visualize Data](./images/AzureMLExperiment.png)

We found that testing with different set of features and machine learning algorithms in Azure ML is very easy. Again, it is very important to use a tool for visualizing the results from the machine learning. To be able to separate noise from real anomalies we experimented a lot with various ways to visualize the residuals between the predicted values and the actual values. We decided to go for a model, where we create a sliding windows of residuals. In the sliding window, we ignore all the values within one standard deviation of the predicted value. Then we calculate the percentage of the difference between the actual value and the predicted value and summed it up over the time window. When visualizing the residuals, we also filtered out the low values.

![Visualize Data](./images/PowerBIVisualize2.jpg)

With this visualization, we could quickly identify anomalies in the water flow values compared with the predicted values. Then we would investigate with the history of reports to see if the anomalies were correlated with the results we got from the machine learning experiments. We learned that one challenge when trying to correlate time series data from sensors with manual entered reports is that the manual reports does not have any precise start / end time for incidents / repairs and they are then quite loosely coupled with the time series data. Therefor we also decided to keep the manual report data out of the machine learning models we worked with. Despite these challenges we could manually correlate anomalies in water flow with actual incidents found in the report system. This strengthened our hypothesis that we would be able to build an application to monitor the current actual water flow and trigger alarms based on anomalies found related to a machine learning predicted curve.

## Architecture

![Solution Architecture](./images/Architecture.png)


## Device used & Code artifacts 

For the Hackfest we used sensor data exported from SCADA system in Excel format. To simulate the flow of real-time sensor data into the system, we created a simulator pushing the data to the Azure IoT Hub.

## Looking forward

We have successfylly demonstrated that we are able to create an application, which can monitor and alert on anomalies in the water flow to help repair leakages as soon as possible.

The next step for the customer is to finish up the last pieces of the demo application and use this in discussion with customers in order to bring this solution to the market.

## Conclusion 

We were able to create reasonably good machine learning models to predict future water flow values based on simple inputs like date and time. We were also able to create good visualization of historical data to highlight the anomalies. This made the job of correlating the anomalies found with the manual reports for issues and repairs for the water distribution system. We also created an end to end demo application for monitoring and alerting potential water leakages. This provided us with enough confidence needed to take this to the next phase.


